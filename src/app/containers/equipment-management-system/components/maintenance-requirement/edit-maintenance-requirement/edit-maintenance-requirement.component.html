<ng-container *ngIf="editing">
  <form (ngSubmit)="clickSaveBtn()" #fixReqForm="ngForm">
    <div class="edit_section">
      <div class="edit_header">
        <div *ngIf="isNewForm" class="title">叫修單新增</div>
        <div *ngIf="!isNewForm" class="title">叫修單編輯</div>
        <div (click)="clickCloseBtn()" class="close_button icon_button"></div>
      </div>
      <div class="edit_detail">
        <div class="label_input">
          <label class="edit_item_label required">銷貨單號</label>
          <input
            class="input"
            placeholder="order no"
            maxlength="15"
            type="text"
            [(ngModel)]="fixReqInfo.order_no"
            name="order_no"
            [class.input_uneditable]="isNewForm && !NewFixReq"
            [disabled]="isNewForm && !NewFixReq"
            required
          />
          <div
            class="error_message"
            *ngIf="fixReqForm.submitted && fixReqForm.form.controls.order_no.hasError('required')"
          >
            必填
          </div>
        </div>
        <div class="label_input date_icon" mat-raised-button (click)="openRequestDatePicker.open()">
          <label class="edit_item_label required">叫修日期</label>
          <input
            class="input pointer"
            readonly
            matInput
            [matDatepicker]="openRequestDatePicker"
            (dateChange)="changeDate('request_date', $event.value)"
            [(ngModel)]="fixReqInfo.request_date"
            placeholder="YYYY-MM-DD"
            name="request_date"
            [class.input_uneditable]="editing && !isNewForm"
            [disabled]="editing && !isNewForm"
            required
          />
          <mat-datepicker [touchUi]="isMobile" #openRequestDatePicker></mat-datepicker>
          <div
            class="error_message"
            *ngIf="
              fixReqForm.submitted && fixReqForm.form.controls.request_date.hasError('required')
            "
          >
            必填
          </div>
        </div>
        <div class="label_input">
          <label class="edit_item_label required">姓名</label>
          <input
            class="input"
            name="user_name"
            maxlength="128"
            [(ngModel)]="fixReqInfo.user_name"
            placeholder="user name"
            name="user_name"
            required
          />
          <div
            class="error_message"
            *ngIf="fixReqForm.submitted && fixReqForm.form.controls.user_name.hasError('required')"
          >
            必填
          </div>
        </div>
        <div class="label_input">
          <label class="edit_item_label required">電話</label>
          <input
            class="input"
            name="phone"
            maxlength="32"
            type="tel"
            (input)="onInput($event)"
            (compositonstart)="onInput($event)"
            [(ngModel)]="fixReqInfo.phone"
            placeholder="phone"
            name="phone"
            required
          />
          <div
            class="error_message"
            *ngIf="fixReqForm.submitted && fixReqForm.form.controls.phone.hasError('required')"
          >
            必填
          </div>
        </div>
        <div class="label_input">
          <label class="edit_item_label required">地址</label>
          <input
            class="input"
            maxlength="128"
            [(ngModel)]="fixReqInfo.address"
            placeholder="address"
            name="address"
            required
          />
          <div
            class="error_message"
            *ngIf="fixReqForm.submitted && fixReqForm.form.controls.address.hasError('required')"
          >
            必填
          </div>
        </div>
        <div class="label_input">
          <label class="edit_item_label">E-mail</label>
          <input
            class="input"
            name="e_mail"
            type="email"
            maxlength="32"
            [(ngModel)]="fixReqInfo.e_mail"
            placeholder="E-mail"
            name="e_mail"
            email
          />
          <div
            class="error_message"
            *ngIf="fixReqForm.submitted && fixReqForm.form.controls.e_mail.hasError('email')"
          >
            email格式錯誤
          </div>
        </div>
        <div *ngIf="!isNewForm" class="label_input">
          <label class="edit_item_label">狀態</label>
          <div class="input_select input">
            <div
              class="foldable"
              [class.unfold]="showRepairStatusDropdown"
              (click)="toggleDropdown('repairStatus')"
            >
              {{ fixReqInfo.status === 'done' ? '完成' : '未完成' }}
            </div>
            <div *ngIf="showRepairStatusDropdown" class="toggle_dropdown">
              <ul>
                <li
                  *ngFor="let repairStatus of repairStatusList"
                  (click)="selectStatus(repairStatus)"
                  class="dropdown_list"
                >
                  {{ repairStatus === 'done' ? '完成' : '未完成' }}
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="label_input">
          <label class="edit_item_label">機台序號</label>
          <div class="input">
            <ng-container *ngIf="fixReqSerialArray">
              <span class="serial_input" *ngFor="let serial_no of fixReqSerialArray; let s = index">
                <span class="font">{{ serial_no }}</span>
                <span
                  (click)="deleteSerial(s)"
                  class="close_button delete_img_button pointer"
                ></span>
              </span>
            </ng-container>
            <span class="serial_input">
              <input
                (click)="ifProdSerialArray()"
                (input)="filterSerialNo()"
                (keydown)="onKeyDown($event)"
                (compositionend)="filterSerialNo()"
                maxlength="300"
                placeholder="serial no"
                type="text"
                [(ngModel)]="tagText"
                name="serial_no"
                autocomplete="off"
              />
              <div *ngIf="isListVisible" class="toggle_dropdown">
                <ul class="dropdown_ul">
                  <li
                    (click)="addSerialNo(serialNo)"
                    class="dropdown_list"
                    *ngFor="let serialNo of filteredSerialNo"
                  >
                    {{ serialNo }}
                  </li>
                </ul>
              </div>
            </span>
          </div>
        </div>
        <div class="memo_label_input">
          <label class="edit_item_label">問題描述</label>
          <textarea
            (input)="countTextLength($event.target.value)"
            maxlength="300"
            class="input"
            [(ngModel)]="fixReqInfo.description"
            name="description"
          ></textarea>
          <span class="textLength">{{ textLength }}/300</span>
        </div>
        <div class="img_label_input">
          <label class="edit_item_label">附加檔案</label>

          <input
            #fileInput
            (change)="previewImg(fileInput)"
            type="file"
            id="img_input"
            name="img_input"
            accept=".jpg,.jpeg,.png,.gif"
          />
          <div class="img_list">
            <ng-container *ngFor="let fileName of fileNames; let index = i">
              <div class="img_wrap">
                <img
                  (click)="openImage(imgPath + fileName)"
                  [src]="imgPath + fileName"
                  alt="附加檔案"
                  id="image_preview"
                />
                <div (click)="deleteImg(fileName)" class="close_button delete_img_button"></div>
              </div>
            </ng-container>
            <label *ngIf="!filesMax" class="img_wrap" for="img_input">
              <div class="add_icon add_img_circle"></div>
            </label>
            <label *ngIf="filesMax">
              <div>圖片數量達上限</div>
            </label>
          </div>
        </div>
      </div>
      <button type="submit" class="save_button">
        <mat-icon class="save_button_icon">save</mat-icon>儲存
      </button>
    </div>
  </form>
</ng-container>
